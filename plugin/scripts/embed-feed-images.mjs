#!/usr/bin/env node
/**
 * Lê os JSONs em plugin/src/ui/feed-json-built e as imagens em plugin/public/feed-images,
 * gera plugin/src/ui/lib/embeddedImages.ts com um mapa path -> data URL.
 * Assim as imagens funcionam no plugin mesmo quando a UI é carregada por blob (Figma).
 *
 * Uso: a partir da pasta plugin/, rodar: node scripts/embed-feed-images.mjs
 */

import fs from "fs";
import path from "path";

const pluginDir = process.cwd();
const feedJsonBuiltDir = path.join(pluginDir, "src", "ui", "feed-json-built");
const publicFeedImagesDir = path.join(pluginDir, "public", "feed-images");
const outPath = path.join(pluginDir, "src", "ui", "lib", "embeddedImages.ts");

const MIME_BY_EXT = {
  ".png": "image/png",
  ".jpg": "image/jpeg",
  ".jpeg": "image/jpeg",
  ".gif": "image/gif",
  ".webp": "image/webp",
};

function getMime(filePath) {
  const ext = path.extname(filePath).toLowerCase();
  return MIME_BY_EXT[ext] || "image/png";
}

function main() {
  if (!fs.existsSync(feedJsonBuiltDir)) {
    console.warn("feed-json-built not found, skipping embed.");
    writeEmpty(outPath);
    return;
  }
  if (!fs.existsSync(publicFeedImagesDir)) {
    console.warn("public/feed-images not found, skipping embed.");
    writeEmpty(outPath);
    return;
  }

  const paths = new Set();
  for (const name of fs.readdirSync(feedJsonBuiltDir)) {
    if (!name.endsWith(".json")) continue;
    const raw = fs.readFileSync(path.join(feedJsonBuiltDir, name), "utf8");
    let arr;
    try {
      arr = JSON.parse(raw);
    } catch {
      continue;
    }
    if (!Array.isArray(arr)) continue;
    for (const item of arr) {
      const img = item?.image;
      if (typeof img === "string" && img.startsWith("/feed-images/")) paths.add(img);
    }
  }

  const entries = [];
  for (const p of paths) {
    const filePath = path.join(publicFeedImagesDir, path.basename(p));
    if (!fs.existsSync(filePath)) continue;
    const buf = fs.readFileSync(filePath);
    const b64 = buf.toString("base64");
    const mime = getMime(filePath);
    const dataUrl = `data:${mime};base64,${b64}`;
    entries.push({ path: p, dataUrl });
  }

  const lines = [
    "// Auto-generated by scripts/embed-feed-images.mjs – do not edit",
    "export const embeddedImageData: Record<string, string> = {",
    ...entries.map((e) => `  ${JSON.stringify(e.path)}: ${JSON.stringify(e.dataUrl)},`),
    "};",
  ];
  fs.writeFileSync(outPath, lines.join("\n"), "utf8");
  console.log(`Embedded ${entries.length} images -> ${path.relative(pluginDir, outPath)}`);
}

function writeEmpty(outPath) {
  fs.writeFileSync(
    outPath,
    "// Auto-generated (empty – run npm run download-images then build)\nexport const embeddedImageData: Record<string, string> = {};\n",
    "utf8"
  );
}

main();
